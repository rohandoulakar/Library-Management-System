<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Library System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<header>
    <h1>Library System</h1>
    <button id="logoutBtn" class="btn danger small">Logout</button>
</header>

<!-- MAIN MESSAGES -->
<div id="msg-area"></div>

<!-- NOTIFICATIONS -->
<section class="panel">
    <h2>Notifications</h2>
    <div id="notif-area" class="notif-box">No notifications</div>
    <br>
    <button id="clearNotifBtn" class="btn small">Clear Notifications</button>
</section>

<!-- LINK TO MY BOOKS -->
<section class="panel">
    <button id="myBooksBtn" class="btn primary">View My Borrowed Books</button>
</section>

<section class="panel">
    <h2>Available Books</h2>
    <table id="bookTable">
        <thead>
            <tr>
                <th>Title</th>
                <th>Status</th>
                <th>Hold Queue</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="bookRows"></tbody>
    </table>
</section>

<script>

function banner(msg, type = "info") {
    document.getElementById("msg-area").innerHTML =
        `<div class="banner ${type}-banner">${msg}</div>`;
}

function renderNotifications(list) {
    const box = document.getElementById("notif-area");
    if (!list || list.length === 0) {
        box.innerHTML = "No notifications";
        return;
    }
    box.innerHTML = list.map(n => `<div class="notif-item">${n}</div>`).join("");
}


async function checkSession() {
    const r = await fetch("/api/currentUser");
    if (!r.ok) {
        window.location.href = "/login.html";
        return;
    }
    loadNotifications();
}

async function loadBooks() {
    const r = await fetch("/api/books");
    const books = await r.json();

    const rows = document.getElementById("bookRows");
    rows.innerHTML = "";

    books.forEach(book => {
        let statusChip =
            book.status === "available" ? `<span class="chip available">Available</span>` :
            book.status === "checked_out" ? `<span class="chip checkedout">Checked Out</span>` :
            `<span class="chip onhold">On Hold</span>`;

        let holdQueue = book.holdQueue.length > 0 ? book.holdQueue.join(", ") : "-";

        rows.innerHTML += `
            <tr>
                <td>${book.title}</td>
                <td>${statusChip}</td>
                <td>${holdQueue}</td>
                <td>
                    <button class="btn small primary" onclick="borrowBook(${book.id})">Borrow</button>
                    <!-- RETURN REMOVED -->
                    <button class="btn small" onclick="placeHold(${book.id})">Hold</button>
                </td>
            </tr>
        `;
    });
}


async function loadNotifications() {
    const r = await fetch("/api/notifications");
    const d = await r.json();
    if (d.success) {
        renderNotifications(d.notifications);
    }
}


async function borrowBook(id) {
    const r = await fetch("/api/borrow", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ bookId: id })
    });
    const d = await r.json();
    banner(d.message, d.success ? "success" : "error");
    loadBooks();
    loadNotifications();
}

async function placeHold(id) {
    const r = await fetch("/api/hold", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ bookId: id })
    });
    const d = await r.json();
    banner(d.message, d.success ? "success" : "error");
    loadBooks();
    loadNotifications();
}


document.getElementById("clearNotifBtn").onclick = async () => {
    await fetch("/api/notifications/clear", { method: "POST" });
    loadNotifications();
    banner("Notifications cleared.", "success");
};


document.getElementById("myBooksBtn").onclick = () => {
    window.location.href = "/mybooks.html";
};

document.getElementById("logoutBtn").onclick = async () => {
    await fetch("/api/logout", { method: "POST" });
    window.location.href = "/login.html";
};

checkSession();
loadBooks();
loadNotifications();
</script>

</body>
</html>
